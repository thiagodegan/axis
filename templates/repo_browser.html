{% extends "base.html" %}
{% from "_macros.html" import render_tree %}
{% block content %}

<div class="flex gap-4 w-full">
  <!-- Sidebar -->
  <aside class="col-span-12 md:col-span-5 lg:col-span-5 xl:col-span-4 rounded-2xl bg-gray-800 shadow p-4 space-y-3 text-slate-100">
    <div class="rounded-2xl bg-slate-900 shadow p-4 space-y-3 text-slate-100">
      <div>
        <div class="text-sm text-slate-400">Repositório</div>
        <div class="font-semibold">{{ owner }}/{{ repo }}</div>
      </div>

      <form method="get" class="flex items-center gap-2">
        <input type="hidden" name="path" value="{{ selected_path or '' }}" />
        <label class="text-sm text-slate-400">Branch</label>
        <select name="ref" class="w-full rounded-xl border border-slate-700 bg-slate-800 text-white px-3 py-1.5" onchange="this.form.submit()">
          {% for b in branches %}
            <option value="{{ b.name }}" {% if b.name == ref %}selected{% endif %}>{{ b.name }}</option>
          {% endfor %}
        </select>
      </form>

      <div class="text-sm text-slate-400">Arquivos</div>
      <div class="max-h-[65vh] overflow-auto pr-1">
        {{ render_tree(tree, owner, repo, ref) }}
      </div>
    </div>
  </aside>

<!-- Editor / Viewer -->
  <section class="col-span-12 md:col-span-7 lg:col-span-8 xl:col-span-9">
    <div class="rounded-3xl bg-slate-800 shadow-xl p-6 text-white border-slate-700 border h-full">
      <div>
        {% if selected_path and file_view %}
          <div class="flex items-center justify-between mb-6">
            <div class="text-sm">
              <div class="font-semibold">{{ selected_path }}</div>
              <div class="text-slate-300">ref: {{ ref }}</div>
            </div>
            <div class="flex items-center gap-3">
              <a href="{{ url_for('repo_browser', owner=owner, repo=repo, ref=ref, path=selected_path) }}"
                 class="text-sm rounded-xl border border-slate-600 px-3 py-1.5 hover:bg-slate-600">Atualizar</a>

              <a href="https://github.com/{{ owner }}/{{ repo }}/blob/{{ ref }}/{{ selected_path }}"
                 target="_blank"
                 class="text-sm rounded-xl border border-slate-600 px-3 py-1.5 hover:bg-slate-600"
                 title="Abrir arquivo no GitHub (externo)">GitHub ↗</a>

              <select id="gen-mode" class="text-sm rounded-xl border border-slate-600 bg-slate-800 text-white px-3 py-1.5">
                <option value="per_unit" selected>Por função/parágrafo</option>
                <option value="whole_file">Arquivo inteiro</option>
              </select>

              {% if selected_path and file_view and file_view.type == 'file' and file_view.is_text %}              
                <button id="btn-generate"
                        class="text-sm rounded-xl bg-slate-900 text-white px-4 py-1.5 hover:opacity-90"
                        onclick="openAnalyzeModal()">
                  Gerar documentação
                </button>
              {% else %}
                <button class="rounded-xl bg-slate-900 text-white px-4 py-1.5 opacity-60 cursor-not-allowed" title="Selecione um arquivo de texto">Gerar documentação</button>
              {% endif %}
            </div>
          </div>

          {% if file_view.type == 'file' and file_view.is_text and file_view.text %}
            <pre class="text-xs overflow-auto rounded-xl border border-slate-600 p-3 bg-slate-800 text-white h-[70vh] whitespace-pre-wrap">{{ file_view.text | e }}</pre>
          {% elif file_view.type == 'file' and not file_view.is_text %}
            <div class="text-slate-400">Este parece ser um arquivo binário (não exibível como texto).</div>
          {% elif file_view.type == 'dir' %}
            <div class="text-slate-400">O caminho selecionado é um diretório.</div>
          {% else %}
            <div class="text-slate-400">Não foi possível exibir o conteúdo.</div>
          {% endif %}
        {% else %}
          <div class="h-full grid place-items-center text-slate-400">
            <div class="text-center px-6">
              <div class="text-lg font-semibold mb-1">Selecione um arquivo à esquerda</div>
              <div>O conteúdo aparecerá aqui com a opção de gerar documentação.</div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
</div>


<!-- Modal de Análise -->
<div id="analyzeModal" class="fixed inset-0 z-50 hidden">
  <!-- overlay -->
  <div class="absolute inset-0 bg-black/40" onclick="closeAnalyzeModal()"></div>

  <!-- card -->
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-full max-w-4xl rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <div>
          <div class="text-sm text-slate-500">Documentação</div>
          <div class="text-base font-semibold truncate">{{ owner }}/{{ repo }}@{{ ref }} — {{ selected_path }}</div>
        </div>
        <button class="rounded-lg px-3 py-1.5 hover:bg-slate-100" onclick="closeAnalyzeModal()">Fechar ✕</button>
      </div>

      <div id="analyzeAlert" class="hidden mx-5 mt-4 rounded-lg border p-3 text-sm"></div>

      <div class="px-5 py-4">
        <!-- Abas -->
        <div class="flex items-center gap-2 text-sm">
          <button id="tab-json" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white" onclick="selectTab('json')">JSON</button>
          <button id="tab-mermaid" class="px-3 py-1.5 rounded-lg hover:bg-slate-100" onclick="selectTab('mermaid')">Mermaid</button>
        </div>

        <!-- Conteúdos -->
        <div id="panel-json" class="mt-3">
          <pre id="analysisJson" class="text-xs overflow-auto rounded-xl border p-3 bg-slate-50 max-h-[60vh] whitespace-pre-wrap">Carregando...</pre>
        </div>

        <div id="panel-mermaid" class="mt-3 hidden">
          <div id="mermaidTabs" class="flex flex-wrap gap-2 mb-2 text-sm"></div>
          <div id="mermaidContainer" class="rounded-xl border p-3 bg-white max-h-[60vh] overflow-auto"></div>
        </div>
      </div>

      <div class="flex items-center justify-between px-5 py-3 border-t">
        <div id="analysisMeta" class="text-xs text-slate-500"></div>
        <div class="flex items-center gap-2">
          <button class="rounded-xl border px-3 py-1.5 hover:bg-slate-50" onclick="copyJson()">Copiar JSON</button>
          <button class="rounded-xl border px-3 py-1.5 opacity-70 cursor-not-allowed" title="Em breve">Baixar Mermaid</button>
          <button class="rounded-xl bg-slate-900 text-white px-4 py-1.5 opacity-70 cursor-not-allowed" title="Em breve">Salvar histórico</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let lastAnalysis = null;

  async function openAnalyzeModal() {
    // Limpa estado
    lastAnalysis = null;
    document.getElementById('analysisJson').textContent = 'Carregando...';
    const btn = document.getElementById('btn-generate');
    btn?.setAttribute('disabled', 'disabled');
    btn?.classList.add('opacity-60','cursor-wait');
    setAlert(null);
    selectTab('json');

    // Abre modal
    document.getElementById('analyzeModal').classList.remove('hidden');

    // Dispara fetch
    const mode = document.getElementById('gen-mode')?.value || 'per_unit';
    await analyzeRequest(mode);
    btn?.removeAttribute('disabled');
    btn?.classList.remove('opacity-60','cursor-wait');
  }

  function closeAnalyzeModal() {
    document.getElementById('analyzeModal').classList.add('hidden');
  }

  function selectTab(which) {
    const tabs = ['json', 'mermaid'];
    tabs.forEach(t => {
      document.getElementById('tab-' + t).classList.remove('bg-slate-900', 'text-white');
      document.getElementById('tab-' + t).classList.add('hover:bg-slate-100');
      document.getElementById('panel-' + t).classList.add('hidden');
    });
    document.getElementById('tab-' + which).classList.add('bg-slate-900', 'text-white');
    document.getElementById('tab-' + which).classList.remove('hover:bg-slate-100');
    document.getElementById('panel-' + which).classList.remove('hidden');
  }

  async function analyzeRequest(mode) {
    try {
      const res = await fetch('{{ url_for("docs_analyze") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          owner: {{ owner|tojson }},
          repo: {{ repo|tojson }},
          ref: {{ ref|tojson }},
          path: {{ selected_path|tojson }},
          mode: mode
        })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        setAlert(`Erro: ${data.error || res.statusText}`, 'error');
        document.getElementById('analysisJson').textContent = JSON.stringify(data, null, 2);
        return;
      }

      lastAnalysis = data;
      document.getElementById('analysisJson').textContent = JSON.stringify(data, null, 2);

      await buildMermaidFromAnalysis(data);

      // meta: contagem e sugestão
      const meta = [];
      if (data?.summary?.unit_count != null) meta.push(`Unidades: ${data.summary.unit_count}`);
      if (data?.summary?.diagram_suggestion) meta.push(`Diagrama sugerido: ${data.summary.diagram_suggestion}`);
      document.getElementById('analysisMeta').textContent = meta.join(' • ');

    } catch (err) {
      setAlert('Erro inesperado ao gerar documentação: ' + (err?.message || err), 'error');
      document.getElementById('analysisJson').textContent = '';
    }
  }

  async function buildMermaidFromAnalysis(analysis) {
    try {
      const res = await fetch('{{ url_for("docs_to_mermaid") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ analysis })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setAlert('Falha ao gerar Mermaid: ' + (data.error || res.statusText), 'error');
        return;
      }
      renderMermaidDiagrams(data.diagrams || []);
    } catch (err) {
      setAlert('Erro inesperado ao gerar Mermaid: ' + (err?.message || err), 'error');
    }
  }

  function renderMermaidDiagrams(diagrams) {
    const tabs = document.getElementById('mermaidTabs');
    const container = document.getElementById('mermaidContainer');
    tabs.innerHTML = '';
    container.innerHTML = '';

    if (!diagrams.length) {
      container.innerHTML = '<div class="text-sm text-slate-600">Nenhum diagrama gerado.</div>';
      return;
    }

    diagrams.forEach((dg, idx) => {
      const btn = document.createElement('button');
      btn.className = 'px-3 py-1.5 rounded-lg ' + (idx === 0 ? 'bg-slate-900 text-white' : 'hover:bg-slate-100');
      btn.textContent = dg.unit_name || dg.unit_id || ('Unidade ' + (idx+1));
      btn.onclick = () => selectMermaid(diagrams, idx);
      tabs.appendChild(btn);
    });

    selectMermaid(diagrams, 0); // renderiza o primeiro
  }

  async function selectMermaid(diagrams, index) {
    const container = document.getElementById('mermaidContainer');
    container.innerHTML = '';

    const dg = diagrams[index];
    let code = (dg.code || 'flowchart TD\nA[Sem conteúdo]');

    // 1) Normaliza quebras de linha vindas do JSON
    code = code.replace(/\\n/g, '\n').replace(/\r\n?/g, '\n').trim();

    // 2) Garante que haja uma quebra de linha após a 1ª linha "flowchart X"
    //    (algumas combinações de template/DOM acabam colando sem \n)
    code = code.replace(/^(\s*flowchart\s+\w+\s*)(?!\n)/i, '$1\n');

    // 3) Renderiza via API (mais robusto que usar <div class="mermaid"> + init)
    const id = 'mmd-' + Date.now();
    try {
      // mermaid.render retorna { svg, bindFunctions }
      const { svg } = await mermaid.render(id, code);
      container.innerHTML = svg;
      // Foca na aba Mermaid para o usuário ver o resultado
      selectTab('mermaid');
    } catch (e) {
      console.error('Mermaid render error:', e);
      // Mostra o código que quebrou, ajuda a depurar
      container.innerHTML = `
        <div class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
          Erro ao renderizar Mermaid. Veja o console para detalhes.
        </div>
        <pre class="text-xs overflow-auto rounded-xl border p-3 bg-slate-50 max-h-[40vh] whitespace-pre-wrap"></pre>`;
      container.querySelector('pre').textContent = code;
      setAlert(e?.message || e?.str || 'Erro desconhecido ao renderizar Mermaid', 'error');
    }
  }

  function setAlert(text, kind) {
    const box = document.getElementById('analyzeAlert');
    if (!text) {
      box.classList.add('hidden');
      box.textContent = '';
      box.className = 'hidden mx-5 mt-4 rounded-lg border p-3 text-sm';
      return;
    }
    box.classList.remove('hidden');
    box.textContent = text;
    box.className = 'mx-5 mt-4 rounded-lg p-3 text-sm border ' + (kind === 'error'
      ? 'bg-red-50 text-red-700 border-red-200'
      : 'bg-green-50 text-green-700 border-green-200');
  }

  async function copyJson() {
    try {
      const txt = document.getElementById('analysisJson').textContent || '';
      await navigator.clipboard.writeText(txt);
      setAlert('JSON copiado para a área de transferência.', 'success');
      setTimeout(() => setAlert(null), 1800);
    } catch {
      setAlert('Não foi possível copiar o JSON.', 'error');
    }
  }
</script>


{% endblock %}

