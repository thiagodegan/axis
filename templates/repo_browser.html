{% extends "base.html" %}
{% from "_macros.html" import render_tree %}
{% block content %}

<div class="grid grid-cols-12 gap-4">
  <!-- Sidebar -->
  <aside class="col-span-12 md:col-span-4 lg:col-span-3 xl:col-span-3">
    <div class="rounded-2xl bg-white shadow p-4 space-y-3">
      <div>
        <div class="text-sm text-slate-500">Reposit√≥rio</div>
        <div class="font-semibold">{{ owner }}/{{ repo }}</div>
      </div>

      <form method="get" class="flex items-center gap-2">
        <input type="hidden" name="path" value="{{ selected_path or '' }}" />
        <label class="text-sm text-slate-500">Branch</label>
        <select name="ref" class="w-full rounded-xl border px-3 py-1.5" onchange="this.form.submit()">
          {% for b in branches %}
            <option value="{{ b.name }}" {% if b.name == ref %}selected{% endif %}>{{ b.name }}</option>
          {% endfor %}
        </select>
      </form>

      <div class="text-sm text-slate-500">Arquivos</div>
      <div class="max-h-[65vh] overflow-auto pr-1">
        <ul class="text-sm">
          {{ render_tree(tree, owner, repo, ref) }}
        </ul>
      </div>
    </div>
  </aside>

  <!-- Editor / Viewer -->
  <section class="col-span-12 md:col-span-8 lg:col-span-9 xl:col-span-9">
    <div class="rounded-2xl bg-white shadow p-4 h-full">
      {% if selected_path and file_view %}
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm">
            <div class="font-semibold">{{ selected_path }}</div>
            <div class="text-slate-500">ref: {{ ref }}</div>
          </div>
          <div class="flex items-center gap-2">
            <a href="{{ url_for('repo_browser', owner=owner, repo=repo, ref=ref, path=selected_path) }}"
               class="rounded-xl border px-3 py-1.5 hover:bg-slate-50">Atualizar</a>
            <button class="rounded-xl bg-slate-900 text-white px-4 py-1.5 opacity-60 cursor-not-allowed"
                    title="Em breve">Gerar documenta√ß√£o</button>
          </div>
        </div>

        {% if file_view.type == 'file' and file_view.is_text and file_view.text %}
          <pre class="text-xs overflow-auto rounded-xl border p-3 bg-slate-50 h-[70vh] whitespace-pre-wrap">{{ file_view.text | e }}</pre>
        {% elif file_view.type == 'file' and not file_view.is_text %}
          <div class="text-slate-600">Este parece ser um arquivo bin√°rio (n√£o exib√≠vel como texto).</div>
        {% elif file_view.type == 'dir' %}
          <div class="text-slate-600">O caminho selecionado √© um diret√≥rio.</div>
        {% else %}
          <div class="text-slate-600">N√£o foi poss√≠vel exibir o conte√∫do.</div>
        {% endif %}
      {% else %}
        <div class="h-full grid place-items-center text-slate-500">
          <div class="text-center px-6">
            <div class="text-lg font-semibold mb-1">Selecione um arquivo √† esquerda</div>
            <div>O conte√∫do aparecer√° aqui com a op√ß√£o de gerar documenta√ß√£o.</div>
          </div>
        </div>
      {% endif %}
    </div>
  </section>
</div>

{% endblock %}

{% macro render_tree(node, owner, repo, ref, base_path="") %}
  {% if node.type == 'dir' %}
    {% for name, child in node.children|dictsort %}
      {% if child.type == 'dir' %}
        <li class="pl-2">
          <details open>
            <summary class="cursor-pointer select-none py-0.5">
              <span class="mr-1">üìÅ</span>{{ name }}
            </summary>
            <ul class="pl-4">
              {% if tree and tree.children %}
                {{ render_tree(tree, owner, repo, ref) }}
              {% else %}
                <li class="p-2 text-slate-400">Nenhum arquivo encontrado nesta ref.</li>
              {% endif %}
            </ul>
          </details>
        </li>
      {% else %}
        <li class="pl-2 py-0.5">
          <a class="hover:underline"
             href="{{ url_for('repo_browser', owner=owner, repo=repo, ref=ref, path=(child.path or (base_path ~ '/' ~ name))) }}">
            <span class="mr-1">üìÑ</span>{{ name }}
          </a>
        </li>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endmacro %}
